tasks:
  - id: ralph-align-mvp
    title: "Ralph PRD Alignment and Completion"
    description: |
      Align the current Ralph harness implementation with PRD.md by addressing
      all discrepancies documented in PRD_DISCREPANCIES.md. Implement missing
      features, fix broken functionality, and ensure full PRD compliance.
    status: open
    acceptance:
      - "All commands in PRD section 10 are implemented and functional"
      - "All config options in PRD section 10 are honored"
      - "Task status transitions match PRD section 8.1"
      - "Prompts include all context from PRD section 12"
      - "Memory hygiene follows PRD section 8.7"
      - "Git discipline follows PRD section 8.6"
      - "Verification follows PRD section 8.5"
      - "All items in PRD_DISCREPANCIES.md are resolved"
    verify:
      - ["go", "build", "./..."]
      - ["go", "test", "./..."]
      - ["golangci-lint", "run"]
    labels:
      area: root
      priority: P0

  - id: ralph-align-cli-config
    title: "CLI and Configuration Foundation"
    parentId: ralph-align-mvp
    description: "Fix configuration loading and basic CLI functionality"
    status: open
    labels:
      area: cli
      priority: P0
      specSection: "Phase 1"

  - id: ralph-align-config-flag
    title: "Honor --config Flag"
    parentId: ralph-align-cli-config
    description: |
      Modify cmd/root.go to store cfgFile and pass to LoadConfig.
      Update all command files to respect the config path from root command.
    status: completed
    acceptance:
      - "ralph --config path/to/ralph.yaml run uses specified config file"
      - "Default behavior unchanged when flag omitted"
      - "Error message shown if specified config file doesn't exist"
    verify:
      - ["go", "test", "./cmd/..."]
      - ["go", "test", "./internal/config/..."]
    labels:
      area: cli
      priority: P0

  - id: ralph-align-claude-args
    title: "Honor claude.command and claude.args"
    parentId: ralph-align-cli-config
    description: |
      Build full command array from config.Claude.Command + config.Claude.Args
      in cmd/run.go and internal/claude/exec.go.
    status: completed
    acceptance:
      - "Config command and args both used in Claude invocation"
      - "Empty args handled correctly"
      - "Unit test verifies command construction"
    verify:
      - ["go", "test", "./internal/claude/..."]
    labels:
      area: cli
      priority: P1

  - id: ralph-align-logs-cmd
    title: "Add ralph logs Command"
    parentId: ralph-align-cli-config
    description: |
      Create cmd/logs.go with --iteration flag to show specific iteration log.
      List available iterations if no flag provided.
      Read from .ralph/logs/iteration-<n>.json and pretty-print.
    status: completed
    acceptance:
      - "ralph logs lists all iterations"
      - "ralph logs --iteration 5 shows iteration 5 details"
      - "Clear error if iteration doesn't exist"
      - "JSON formatted for readability"
    verify:
      - ["go", "test", "./cmd/..."]
    labels:
      area: cli
      priority: P1

  - id: ralph-align-revert-cmd
    title: "Add ralph revert Command"
    parentId: ralph-align-cli-config
    description: |
      Create cmd/revert.go with --iteration flag to reset to before that iteration.
      Uses GitManager to git reset --hard and updates task status.
      Requires confirmation unless --force flag.
    status: open
    acceptance:
      - "ralph revert --iteration 5 resets to before iteration 5"
      - "Requires confirmation prompt"
      - "Updates task status correctly"
      - "Error if iteration doesn't exist or git fails"
    verify:
      - ["go", "test", "./cmd/..."]
    labels:
      area: cli
      priority: P2

  - id: ralph-align-pause-check
    title: "Fix ralph pause Checking"
    parentId: ralph-align-cli-config
    description: |
      Modify internal/loop/controller.go to check pause flag in main loop
      before selecting next task, not just at start of run.
    status: completed
    acceptance:
      - "Running ralph pause in another terminal stops loop after current iteration"
      - "Status message shows paused state"
      - "ralph resume allows loop to continue"
    verify:
      - ["go", "test", "./internal/loop/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-task-storage
    title: "Task Storage and Status Management"
    parentId: ralph-align-mvp
    description: "Fix task status transitions and enable YAML import"
    status: open
    labels:
      area: core
      priority: P0
      specSection: "Phase 2"

  - id: ralph-align-task-status
    title: "Implement Task Status Transitions"
    parentId: ralph-align-task-storage
    description: |
      Modify internal/loop/controller.go to set failed status when max retries
      exceeded and blocked status on gutter detection.
      Track attempt count in iteration state or task metadata.
    status: completed
    acceptance:
      - "Tasks failing max retries are marked failed"
      - "Tasks hitting gutter detection are marked blocked"
      - "ralph status shows accurate failed/blocked counts"
      - "Blocked/failed tasks skip selection until manually reset"
    verify:
      - ["go", "test", "./internal/loop/..."]
      - ["go", "test", "./internal/taskstore/..."]
    labels:
      area: core
      priority: P0

  - id: ralph-align-yaml-import
    title: "Add YAML Import CLI Command"
    parentId: ralph-align-task-storage
    description: |
      Create cmd/import.go to read YAML file and call taskstore.ImportFromYAML.
      Validates all tasks before importing.
      Add --overwrite flag to replace existing tasks.
    status: open
    acceptance:
      - "ralph import tasks.yaml loads tasks into store"
      - "Validation errors show task IDs and reasons"
      - "Existing tasks not overwritten unless --overwrite"
      - "Import is atomic (all or nothing)"
    verify:
      - ["go", "test", "./cmd/..."]
    labels:
      area: cli
      priority: P1

  - id: ralph-align-task-linter
    title: "Implement Task Linter"
    parentId: ralph-align-task-storage
    dependsOn:
      - ralph-align-yaml-import
    description: |
      Create internal/taskstore/linter.go to validate tasks.
      Call linter in ralph init and ralph import.
    status: open
    acceptance:
      - "Init fails if tasks are invalid"
      - "Import fails if tasks are invalid"
      - "Clear error messages identify specific problems"
      - "Unit tests for each validation rule"
    verify:
      - ["go", "test", "./internal/taskstore/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-prompts
    title: "Prompt Engineering and Context Packaging"
    parentId: ralph-align-mvp
    description: "Use the full prompt builder with all required context"
    status: open
    labels:
      area: core
      priority: P0
      specSection: "Phase 3"

  - id: ralph-align-iteration-prompt
    title: "Integrate Iteration Prompt Builder"
    parentId: ralph-align-prompts
    description: |
      Replace minimal prompt in internal/loop/controller.go with
      prompt.BuildIterationPrompt. Include system prompt, task details,
      acceptance, verify commands, Codebase Patterns, git diff stat.
      Enforce size limits (default 100KB).
    status: completed
    acceptance:
      - "Generated prompts include all PRD-specified context"
      - "Size limits enforced; context trimmed if needed"
      - "System prompt follows PRD template"
      - "Unit tests verify all sections present"
    verify:
      - ["go", "test", "./internal/prompt/..."]
      - ["go", "test", "./internal/loop/..."]
    labels:
      area: core
      priority: P0

  - id: ralph-align-retry-prompt
    title: "Integrate Retry Prompt Builder"
    parentId: ralph-align-prompts
    description: |
      Call prompt.BuildRetryPrompt on verification failure in
      internal/loop/controller.go. Include trimmed failure output,
      fix-only directive, and user feedback if provided.
    status: completed
    acceptance:
      - "Retry prompts include trimmed failure output"
      - "Fix-only directive present and clear"
      - "User feedback appended when provided"
      - "Trimming respects max lines config (default 100 lines)"
    verify:
      - ["go", "test", "./internal/prompt/..."]
    labels:
      area: core
      priority: P0

  - id: ralph-align-codebase-patterns
    title: "Extract and Use Codebase Patterns"
    parentId: ralph-align-prompts
    description: |
      Implement GetCodebasePatterns in internal/memory/progress.go to
      extract Codebase Patterns section. Include in prompt builder.
    status: completed
    acceptance:
      - "GetCodebasePatterns extracts patterns section"
      - "Patterns included in every Claude iteration prompt"
      - "Empty patterns section handled gracefully"
      - "Unit tests for extraction"
    verify:
      - ["go", "test", "./internal/memory/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-verification
    title: "Verification and In-Iteration Retry"
    parentId: ralph-align-mvp
    dependsOn:
      - ralph-align-prompts
    description: "Enable config-level verification commands and in-iteration fix loop"
    status: open
    labels:
      area: core
      priority: P0
      specSection: "Phase 4"

  - id: ralph-align-config-verify
    title: "Use Config-Level Verification Commands"
    parentId: ralph-align-verification
    description: |
      Merge config-level and task-level verify commands in
      internal/loop/controller.go. Run both sets of commands.
    status: open
    acceptance:
      - "Both config and task verification commands execute"
      - "All must pass for iteration to succeed"
      - "Clear output showing which command failed"
      - "Config commands optional if not specified"
    verify:
      - ["go", "test", "./internal/loop/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-retry-loop
    title: "Implement In-Iteration Retry Loop"
    parentId: ralph-align-verification
    dependsOn:
      - ralph-align-retry-prompt
    description: |
      After Claude run, if verification fails, build retry prompt and
      invoke Claude again with --continue. Repeat up to max_verification_retries.
      Add loop.max_verification_retries to config (default 2).
    status: open
    acceptance:
      - "Claude gets chances to fix verification failures"
      - "Retry prompts are fix-only focused"
      - "Max retries configurable"
      - "Attempt count tracked in iteration record"
    verify:
      - ["go", "test", "./internal/loop/..."]
      - ["go", "test", "./internal/config/..."]
    labels:
      area: core
      priority: P0

  - id: ralph-align-iteration-timeout
    title: "Enforce Per-Iteration Time Limit"
    parentId: ralph-align-verification
    description: |
      Create context with timeout in internal/loop/controller.go.
      Pass to Claude runner. Cancel if timeout exceeded.
      Update budget tracking.
    status: open
    acceptance:
      - "Claude subprocess killed if iteration exceeds time limit"
      - "Iteration marked as budget_exceeded"
      - "Budget JSON tracks iteration durations"
      - "Config default: 20 minutes"
    verify:
      - ["go", "test", "./internal/loop/..."]
      - ["go", "test", "./internal/loop/budget.go"]
    labels:
      area: core
      priority: P1

  - id: ralph-align-git-reporting
    title: "Git Discipline and Reporting"
    parentId: ralph-align-mvp
    description: "Create feature branches and improve reporting"
    status: open
    labels:
      area: core
      priority: P1
      specSection: "Phase 5"

  - id: ralph-align-feature-branch
    title: "Create and Use Feature Branches"
    parentId: ralph-align-git-reporting
    description: |
      Call gitManager.EnsureBranch at start of run in internal/loop/controller.go.
      Generate branch name from parent task: ralph/<parent-task-title-slug>.
      Update ralph init to suggest branch creation.
    status: open
    acceptance:
      - "ralph run creates/switches to feature branch"
      - "Branch name format: ralph/<feature-name>"
      - "Existing branches reused"
      - "User can override with --branch flag"
    verify:
      - ["go", "test", "./internal/loop/..."]
      - ["go", "test", "./internal/git/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-text-logs
    title: "Generate Human-Readable Iteration Logs"
    parentId: ralph-align-git-reporting
    description: |
      Modify internal/loop/record.go to generate text summary after saving JSON.
      Write to .ralph/logs/iteration-<n>.txt with task, times, outcome, files, commit.
    status: open
    acceptance:
      - "Both .json and .txt logs created per iteration"
      - "Text log is human-readable"
      - "Text log includes key metrics"
      - "ralph logs can show text version"
    verify:
      - ["go", "test", "./internal/loop/..."]
    labels:
      area: core
      priority: P2

  - id: ralph-align-commit-messages
    title: "Include Commit Messages in Reports"
    parentId: ralph-align-git-reporting
    description: |
      Add GetCommitMessage method to internal/git/manager.go.
      Modify internal/reporter/report.go to call it and populate CommitInfo.Message.
    status: open
    acceptance:
      - "Reports include commit messages"
      - "Messages formatted cleanly"
      - "Errors handled if commit missing"
    verify:
      - ["go", "test", "./internal/git/..."]
      - ["go", "test", "./internal/reporter/..."]
    labels:
      area: core
      priority: P2

  - id: ralph-align-memory
    title: "Memory Hygiene and Long-Term State"
    parentId: ralph-align-mvp
    description: "Archive progress, enforce size limits, manage AGENTS.md"
    status: open
    labels:
      area: core
      priority: P1
      specSection: "Phase 6"

  - id: ralph-align-archive-progress
    title: "Archive Old Progress on Feature Switch"
    parentId: ralph-align-memory
    description: |
      Modify cmd/init.go to call memoryManager.ArchiveProgress when setting
      new parent task different from previous.
      Store previous parent ID in state to detect changes.
    status: open
    acceptance:
      - "Old progress moved to .ralph/archive/progress-TIMESTAMP.md"
      - "New progress.md created with header"
      - "Feature name and parent ID in header"
      - "Archive only happens on parent task change"
    verify:
      - ["go", "test", "./cmd/..."]
      - ["go", "test", "./internal/memory/..."]
    labels:
      area: core
      priority: P2

  - id: ralph-align-progress-limits
    title: "Enforce Progress File Size Limits"
    parentId: ralph-align-memory
    description: |
      After appending iteration in internal/memory/progress.go, check file size.
      If exceeds config limit (default 1MB), prune oldest entries while preserving
      header, Codebase Patterns, and recent N iterations (default 20).
      Add memory.max_progress_bytes to config.
    status: open
    acceptance:
      - "Progress file stays under size limit"
      - "Header and patterns never pruned"
      - "Recent iterations preserved"
      - "Pruning note added when triggered"
    verify:
      - ["go", "test", "./internal/memory/..."]
      - ["go", "test", "./internal/config/..."]
    labels:
      area: core
      priority: P2

  - id: ralph-align-agents-md
    title: "Support AGENTS.md Updates"
    parentId: ralph-align-memory
    description: |
      Create internal/memory/agents.go with FindAgentsMd and ReadAgentsMd.
      Modify internal/prompt/iteration.go to include AGENTS.md guidance
      and existing AGENTS.md content in prompts.
    status: open
    acceptance:
      - "System prompt includes AGENTS.md guidance"
      - "Existing AGENTS.md files read and included in context"
      - "No automatic creation; Claude decides when to add"
      - "Unit tests for file discovery"
    verify:
      - ["go", "test", "./internal/memory/..."]
      - ["go", "test", "./internal/prompt/..."]
    labels:
      area: core
      priority: P2

  - id: ralph-align-safety
    title: "Safety and Robustness"
    parentId: ralph-align-mvp
    description: "Enable sandbox mode, command allowlists, better gutter detection"
    status: open
    labels:
      area: core
      priority: P1
      specSection: "Phase 7"

  - id: ralph-align-sandbox
    title: "Implement Sandbox Mode Guard"
    parentId: ralph-align-safety
    description: |
      Modify internal/claude/exec.go and internal/verifier/runner.go to check
      commands against allowlist when config.Safety.Sandbox is true.
      Use Claude Code's --allowedTools flag to restrict tools.
    status: open
    acceptance:
      - "Sandbox mode blocks disallowed commands"
      - "Clear error message when blocked"
      - "Allowlist configurable in ralph.yaml"
      - "Default allowlist: npm, go, git"
    verify:
      - ["go", "test", "./internal/claude/..."]
      - ["go", "test", "./internal/verifier/..."]
    labels:
      area: security
      priority: P1

  - id: ralph-align-gutter
    title: "Improve Gutter Detection"
    parentId: ralph-align-safety
    description: |
      Enhance internal/loop/gutter.go to detect oscillation (files modified
      back and forth using content hash), no-progress commits, and failure
      signatures across iterations. Add gutter config options.
    status: open
    acceptance:
      - "Oscillation detected when file changes revert"
      - "Content hash prevents false positives"
      - "All thresholds configurable"
      - "Unit tests for each detection type"
    verify:
      - ["go", "test", "./internal/loop/..."]
      - ["go", "test", "./internal/config/..."]
    labels:
      area: core
      priority: P1

  - id: ralph-align-retry-feedback
    title: "Add Retry Feedback Support"
    parentId: ralph-align-safety
    dependsOn:
      - ralph-align-task-status
    description: |
      Add --feedback flag to cmd/retry.go to store user feedback.
      Modify internal/loop/controller.go to read feedback and pass to retry prompt.
      Create .ralph/state/retry-feedback.json state file.
    status: open
    acceptance:
      - "ralph retry --task X --feedback 'message' stores feedback"
      - "Next iteration includes feedback in retry prompt"
      - "Feedback cleared after successful iteration"
      - "Feedback shown in status command"
    verify:
      - ["go", "test", "./cmd/..."]
      - ["go", "test", "./internal/loop/..."]
    labels:
      area: core
      priority: P2
